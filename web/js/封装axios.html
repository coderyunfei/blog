<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何优雅地封装 axios | Jack 的博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="vue 教程">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f40e0164.css" as="style"><link rel="preload" href="/blog/assets/js/app.f600d07b.js" as="script"><link rel="preload" href="/blog/assets/js/2.2efda491.js" as="script"><link rel="preload" href="/blog/assets/js/156.cd63d656.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.5759b5a6.js"><link rel="prefetch" href="/blog/assets/js/100.c11c94a0.js"><link rel="prefetch" href="/blog/assets/js/101.7e06bfc4.js"><link rel="prefetch" href="/blog/assets/js/102.cb80e24c.js"><link rel="prefetch" href="/blog/assets/js/103.9e50ef4d.js"><link rel="prefetch" href="/blog/assets/js/104.f367892d.js"><link rel="prefetch" href="/blog/assets/js/105.2533e8b9.js"><link rel="prefetch" href="/blog/assets/js/106.c75fd75e.js"><link rel="prefetch" href="/blog/assets/js/107.e85e7607.js"><link rel="prefetch" href="/blog/assets/js/108.37bf02c9.js"><link rel="prefetch" href="/blog/assets/js/109.e73f9d25.js"><link rel="prefetch" href="/blog/assets/js/11.db96e8cb.js"><link rel="prefetch" href="/blog/assets/js/110.bae650db.js"><link rel="prefetch" href="/blog/assets/js/111.b7182f59.js"><link rel="prefetch" href="/blog/assets/js/112.5ffa81c6.js"><link rel="prefetch" href="/blog/assets/js/113.d3bcacac.js"><link rel="prefetch" href="/blog/assets/js/114.ab5de741.js"><link rel="prefetch" href="/blog/assets/js/115.1504cff6.js"><link rel="prefetch" href="/blog/assets/js/116.65ce00ed.js"><link rel="prefetch" href="/blog/assets/js/117.775044e3.js"><link rel="prefetch" href="/blog/assets/js/118.4b6fa708.js"><link rel="prefetch" href="/blog/assets/js/119.6cf264d3.js"><link rel="prefetch" href="/blog/assets/js/12.7cf66971.js"><link rel="prefetch" href="/blog/assets/js/120.232630d7.js"><link rel="prefetch" href="/blog/assets/js/121.c945ae58.js"><link rel="prefetch" href="/blog/assets/js/122.47855d40.js"><link rel="prefetch" href="/blog/assets/js/123.237e1c10.js"><link rel="prefetch" href="/blog/assets/js/124.b7b86e27.js"><link rel="prefetch" href="/blog/assets/js/125.b26e3cf6.js"><link rel="prefetch" href="/blog/assets/js/126.63ac6d42.js"><link rel="prefetch" href="/blog/assets/js/127.e04913de.js"><link rel="prefetch" href="/blog/assets/js/128.0915a9dd.js"><link rel="prefetch" href="/blog/assets/js/129.f022d29b.js"><link rel="prefetch" href="/blog/assets/js/13.28979dcf.js"><link rel="prefetch" href="/blog/assets/js/130.740fc885.js"><link rel="prefetch" href="/blog/assets/js/131.8f3276f3.js"><link rel="prefetch" href="/blog/assets/js/132.891ae0b7.js"><link rel="prefetch" href="/blog/assets/js/133.34268944.js"><link rel="prefetch" href="/blog/assets/js/134.ef560a04.js"><link rel="prefetch" href="/blog/assets/js/135.4951f5e9.js"><link rel="prefetch" href="/blog/assets/js/136.24ef2c84.js"><link rel="prefetch" href="/blog/assets/js/137.e10dbb5c.js"><link rel="prefetch" href="/blog/assets/js/138.1da174d1.js"><link rel="prefetch" href="/blog/assets/js/139.1111468f.js"><link rel="prefetch" href="/blog/assets/js/14.73229591.js"><link rel="prefetch" href="/blog/assets/js/140.be162f64.js"><link rel="prefetch" href="/blog/assets/js/141.2fce3f92.js"><link rel="prefetch" href="/blog/assets/js/142.a41604d1.js"><link rel="prefetch" href="/blog/assets/js/143.f9d1aa4c.js"><link rel="prefetch" href="/blog/assets/js/144.ab226e1c.js"><link rel="prefetch" href="/blog/assets/js/145.6324972b.js"><link rel="prefetch" href="/blog/assets/js/146.86b94236.js"><link rel="prefetch" href="/blog/assets/js/147.3ed1819e.js"><link rel="prefetch" href="/blog/assets/js/148.e821ae82.js"><link rel="prefetch" href="/blog/assets/js/149.9a720c7e.js"><link rel="prefetch" href="/blog/assets/js/15.4f1e002e.js"><link rel="prefetch" href="/blog/assets/js/150.227aac9d.js"><link rel="prefetch" href="/blog/assets/js/151.37aa781a.js"><link rel="prefetch" href="/blog/assets/js/152.0a82015a.js"><link rel="prefetch" href="/blog/assets/js/153.238470cb.js"><link rel="prefetch" href="/blog/assets/js/154.78fe63ef.js"><link rel="prefetch" href="/blog/assets/js/155.7f5fba4a.js"><link rel="prefetch" href="/blog/assets/js/157.576bc526.js"><link rel="prefetch" href="/blog/assets/js/158.e2e30983.js"><link rel="prefetch" href="/blog/assets/js/159.8fe06f36.js"><link rel="prefetch" href="/blog/assets/js/16.52685b60.js"><link rel="prefetch" href="/blog/assets/js/160.956e0c74.js"><link rel="prefetch" href="/blog/assets/js/161.22693bfe.js"><link rel="prefetch" href="/blog/assets/js/162.722bbc15.js"><link rel="prefetch" href="/blog/assets/js/163.f00c05f0.js"><link rel="prefetch" href="/blog/assets/js/164.80cf33ec.js"><link rel="prefetch" href="/blog/assets/js/17.86d1ee1c.js"><link rel="prefetch" href="/blog/assets/js/18.3005d22e.js"><link rel="prefetch" href="/blog/assets/js/19.217ec3f9.js"><link rel="prefetch" href="/blog/assets/js/20.f819104b.js"><link rel="prefetch" href="/blog/assets/js/21.9c4ffbca.js"><link rel="prefetch" href="/blog/assets/js/22.0aea007b.js"><link rel="prefetch" href="/blog/assets/js/23.2eb06be8.js"><link rel="prefetch" href="/blog/assets/js/24.23dae9ca.js"><link rel="prefetch" href="/blog/assets/js/25.b70e20cb.js"><link rel="prefetch" href="/blog/assets/js/26.9a61c322.js"><link rel="prefetch" href="/blog/assets/js/27.ac5ed80b.js"><link rel="prefetch" href="/blog/assets/js/28.9114ae6c.js"><link rel="prefetch" href="/blog/assets/js/29.f8eab0e6.js"><link rel="prefetch" href="/blog/assets/js/3.6fec1244.js"><link rel="prefetch" href="/blog/assets/js/30.79b9fd10.js"><link rel="prefetch" href="/blog/assets/js/31.24f1d3e3.js"><link rel="prefetch" href="/blog/assets/js/32.cb8c8e14.js"><link rel="prefetch" href="/blog/assets/js/33.50564978.js"><link rel="prefetch" href="/blog/assets/js/34.93d14ef6.js"><link rel="prefetch" href="/blog/assets/js/35.9d1649ee.js"><link rel="prefetch" href="/blog/assets/js/36.9bc1f106.js"><link rel="prefetch" href="/blog/assets/js/37.84853c82.js"><link rel="prefetch" href="/blog/assets/js/38.9f600edf.js"><link rel="prefetch" href="/blog/assets/js/39.b47cb433.js"><link rel="prefetch" href="/blog/assets/js/4.ec0140bd.js"><link rel="prefetch" href="/blog/assets/js/40.9ccc0594.js"><link rel="prefetch" href="/blog/assets/js/41.01250879.js"><link rel="prefetch" href="/blog/assets/js/42.d60a39ea.js"><link rel="prefetch" href="/blog/assets/js/43.bb6abe12.js"><link rel="prefetch" href="/blog/assets/js/44.f1827278.js"><link rel="prefetch" href="/blog/assets/js/45.f3339292.js"><link rel="prefetch" href="/blog/assets/js/46.1c304a2b.js"><link rel="prefetch" href="/blog/assets/js/47.431a2b22.js"><link rel="prefetch" href="/blog/assets/js/48.ad234636.js"><link rel="prefetch" href="/blog/assets/js/49.67ad5b83.js"><link rel="prefetch" href="/blog/assets/js/5.3ec83be7.js"><link rel="prefetch" href="/blog/assets/js/50.b0733796.js"><link rel="prefetch" href="/blog/assets/js/51.c86649b3.js"><link rel="prefetch" href="/blog/assets/js/52.e2228f69.js"><link rel="prefetch" href="/blog/assets/js/53.8e49c1f4.js"><link rel="prefetch" href="/blog/assets/js/54.5542fcf9.js"><link rel="prefetch" href="/blog/assets/js/55.bf4d78dd.js"><link rel="prefetch" href="/blog/assets/js/56.ac5dd9d6.js"><link rel="prefetch" href="/blog/assets/js/57.b9a9c4a2.js"><link rel="prefetch" href="/blog/assets/js/58.f8dfabd2.js"><link rel="prefetch" href="/blog/assets/js/59.ef9edf8c.js"><link rel="prefetch" href="/blog/assets/js/6.a48d7718.js"><link rel="prefetch" href="/blog/assets/js/60.6ac72368.js"><link rel="prefetch" href="/blog/assets/js/61.46bc7de5.js"><link rel="prefetch" href="/blog/assets/js/62.b9fa4071.js"><link rel="prefetch" href="/blog/assets/js/63.ef4370f5.js"><link rel="prefetch" href="/blog/assets/js/64.a436c5be.js"><link rel="prefetch" href="/blog/assets/js/65.fb4bf376.js"><link rel="prefetch" href="/blog/assets/js/66.bad0cffd.js"><link rel="prefetch" href="/blog/assets/js/67.29b8bb71.js"><link rel="prefetch" href="/blog/assets/js/68.b7ae577e.js"><link rel="prefetch" href="/blog/assets/js/69.5a855c9d.js"><link rel="prefetch" href="/blog/assets/js/7.e84e9cdf.js"><link rel="prefetch" href="/blog/assets/js/70.df9ab8df.js"><link rel="prefetch" href="/blog/assets/js/71.9328d7e2.js"><link rel="prefetch" href="/blog/assets/js/72.3580533a.js"><link rel="prefetch" href="/blog/assets/js/73.16ba35eb.js"><link rel="prefetch" href="/blog/assets/js/74.2d0d9b5b.js"><link rel="prefetch" href="/blog/assets/js/75.09e10dbd.js"><link rel="prefetch" href="/blog/assets/js/76.56e0338c.js"><link rel="prefetch" href="/blog/assets/js/77.a99acafc.js"><link rel="prefetch" href="/blog/assets/js/78.17d1d404.js"><link rel="prefetch" href="/blog/assets/js/79.50ed2296.js"><link rel="prefetch" href="/blog/assets/js/8.d6346ba1.js"><link rel="prefetch" href="/blog/assets/js/80.6d76cbea.js"><link rel="prefetch" href="/blog/assets/js/81.7a8a8125.js"><link rel="prefetch" href="/blog/assets/js/82.ab110344.js"><link rel="prefetch" href="/blog/assets/js/83.534159b7.js"><link rel="prefetch" href="/blog/assets/js/84.1cacb036.js"><link rel="prefetch" href="/blog/assets/js/85.6ea1a18c.js"><link rel="prefetch" href="/blog/assets/js/86.45d2d704.js"><link rel="prefetch" href="/blog/assets/js/87.397bf3ec.js"><link rel="prefetch" href="/blog/assets/js/88.a3ac0d51.js"><link rel="prefetch" href="/blog/assets/js/89.181ef1b6.js"><link rel="prefetch" href="/blog/assets/js/9.10eb84ee.js"><link rel="prefetch" href="/blog/assets/js/90.cf532ce7.js"><link rel="prefetch" href="/blog/assets/js/91.6a34527e.js"><link rel="prefetch" href="/blog/assets/js/92.64450dbe.js"><link rel="prefetch" href="/blog/assets/js/93.d99dd7ba.js"><link rel="prefetch" href="/blog/assets/js/94.6300a04e.js"><link rel="prefetch" href="/blog/assets/js/95.74437fc5.js"><link rel="prefetch" href="/blog/assets/js/96.726f109c.js"><link rel="prefetch" href="/blog/assets/js/97.d9b26abd.js"><link rel="prefetch" href="/blog/assets/js/98.7c6a019e.js"><link rel="prefetch" href="/blog/assets/js/99.1e91aa55.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f40e0164.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Jack 的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue2/" class="nav-link">
  vue2
</a></div><div class="nav-item"><a href="/blog/vue3/" class="nav-link">
  vue3
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/blog/science/" class="nav-link">
  科学
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/js/" class="nav-link router-link-active">
  js
</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/" class="nav-link">
  webpack
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/others/functional-programming/" class="nav-link">
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/blog/angular/" class="nav-link">
  angular
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/dev-tool/" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/mac/" class="nav-link">
  mac使用
</a></li></ul></div></div> <a href="https://github.com/jackchoumine/vue-press-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue2/" class="nav-link">
  vue2
</a></div><div class="nav-item"><a href="/blog/vue3/" class="nav-link">
  vue3
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  react
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/blog/science/" class="nav-link">
  科学
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web" class="dropdown-title"><span class="title">web</span> <span class="arrow down"></span></button> <button type="button" aria-label="web" class="mobile-dropdown-title"><span class="title">web</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/js/" class="nav-link router-link-active">
  js
</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/" class="nav-link">
  webpack
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/others/functional-programming/" class="nav-link">
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/blog/angular/" class="nav-link">
  angular
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/dev-tool/" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/mac/" class="nav-link">
  mac使用
</a></li></ul></div></div> <a href="https://github.com/jackchoumine/vue-press-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>如何优雅地封装 axios</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#封装实现" class="sidebar-link">封装实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#基本封装" class="sidebar-link">基本封装</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#如何在组件种中更方便的使用" class="sidebar-link">如何在组件种中更方便的使用</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#如何优雅得封装-post" class="sidebar-link">如何优雅得封装 POST</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#如何处理错误" class="sidebar-link">如何处理错误</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#如何取消请求" class="sidebar-link">如何取消请求</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#取消的原理" class="sidebar-link">取消的原理</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#如何取消重复请求" class="sidebar-link">如何取消重复请求</a></li><li class="sidebar-sub-header"><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#取消重复请求的具体实现" class="sidebar-link">取消重复请求的具体实现</a></li></ul></li><li><a href="/blog/web/js/%E5%B0%81%E8%A3%85axios.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="如何优雅地封装-axios"><a href="#如何优雅地封装-axios" class="header-anchor">#</a> 如何优雅地封装 axios</h1> <p>工作中接手他人的项目，看到一些 axios 封装很是复杂，难用，现在来总结一下 axios 封装 xhr 的问题。</p> <p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h856xt5v1tj306k08wt9h.jpg" alt=""></p> <p>在 vue 项目中使用，希望达到下面的效果：</p> <ul><li><p>引用方便，在组件中，通过 <code>this.$http[method]</code> 使用；</p></li> <li><p>兼容 REST 风格封装，使用 JSON 进行交互，提供常用的四种方法；</p></li> <li><p>不同请求方法，参数格式一致，<code>this.$http.get(url,params)</code>、<code>this.$http.post(url,params)</code>；</p></li> <li><p>可进行二次确认，<code>this.$http.delete(url,params,{content:'删除后不可恢复!',type:'danger'})</code>；</p></li> <li><p>统一处理错误，同时提供抛出错误的方法，比如 <code>this.$http.getWithError(url)</code>，使用时可在函数里捕获错误；</p></li> <li><p>错误时，控制台有特别的日志输出，要是公司有条件，可提交到服务器，方便排查问题；</p></li> <li><p>重复请求，可取消；</p></li> <li><p>用户切换路径，取消请求；</p></li> <li><p>文件下载；</p></li></ul> <blockquote><p>额外的功能</p></blockquote> <p>有 mock 服务的，可指定是否走 mock 服务，似乎很多公司都没有这个。</p> <p>能想到的就是以上了，根据上面的需求，封装 GET 和 POST</p> <h2 id="封装实现"><a href="#封装实现" class="header-anchor">#</a> 封装实现</h2> <h3 id="基本封装"><a href="#基本封装" class="header-anchor">#</a> 基本封装</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> logInfo<span class="token punctuation">,</span> redLog<span class="token punctuation">,</span> blackLog <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils'</span>
<span class="token comment">// 创建一个实例，此后都在此实例上改造</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// timeout: 1000 * 4,</span>
  <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 请求拦截器</span>
<span class="token keyword">const</span> <span class="token function-variable function">beforeRequest</span> <span class="token operator">=</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置 token</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
  token <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authorization <span class="token operator">=</span> token<span class="token punctuation">)</span>
  <span class="token comment">// NOTE  添加自定义头部</span>
  config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'my-header'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'jack'</span>
  <span class="token keyword">return</span> config
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>beforeRequest<span class="token punctuation">)</span>

<span class="token comment">// 响应拦截器</span>
<span class="token keyword">const</span> <span class="token function-variable function">responseSuccess</span> <span class="token operator">=</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// eslint-disable-next-line yoda</span>
  <span class="token comment">// 这里没有必要进行判断，axios 内部已经判断</span>
  <span class="token comment">// const isOk = 200 &lt;= response.status &amp;&amp; response.status &lt; 300</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">responseFailed</span> <span class="token operator">=</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> response <span class="token punctuation">}</span> <span class="token operator">=</span> error
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// handleError(response)</span>
    <span class="token function">logInfo</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token comment">// cons error = new Error(response.data.msg)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">redLog</span><span class="token punctuation">(</span><span class="token string">'没有网络'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'请检查网络连接'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
http<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>responseSuccess<span class="token punctuation">,</span> responseFailed<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  get<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><blockquote><p>关于请求头的指定</p></blockquote> <p>axios 根据参数格式，自动采设置<code>content-type</code>：传递对象，设置为 json 提交，传递字符串时，资源设置为 <code>application/x-www-form-urlencoded;charset=UTF-8</code>。</p> <blockquote><p>希望只传递对象，且不想 axios 自动设置，就手动设置 content-type 为 <code>json</code></p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json;charset=UTF-8'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>关于拦截器</p></blockquote> <p>可在请求发送之前和返回之后，在拦截器里做一些你想要的操作，比如转化格式，添加自定义的请求头，处理错误，都是在拦截器里操作。这正是我们使用它的理由。</p> <p>拦截器接收两个函数，第一个 <code>onResolved</code>，第二个为<code>onRejected</code>，他们的作用和 promise.then 的参数一致。</p> <p>希望在请求发送之前执行某些操作，自请求拦截器里操作。</p> <p>希望在响应返回 JS 代码之前，执行操作在响应拦截器里操作。</p> <blockquote><p>axios 不知道返回我们希望的数据，需要在响应拦截器里处理一下：</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">responseSuccess</span> <span class="token operator">=</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// eslint-disable-next-line yoda</span>
  <span class="token comment">// 这里没有必要进行判断，axios 内部已经判断</span>
  <span class="token comment">// const isOk = 200 &lt;= response.status &amp;&amp; response.status &lt; 300</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>错误处理，很关键</p></blockquote> <p>在响应拦截器里统一处理常见的错误，比如<code>404</code>、<code>403</code>、断网等。</p> <div class="custom-block tip"><p class="custom-block-title">争论</p> <blockquote><p>只有 status 为 200 --- 299 才是成功吗？</p></blockquote> <p>REST 风格主张在接口设计中充分利用 http 语义，使用 http 状态码来表示接口状态，我也喜欢这种方式。有几个好处：</p> <ol><li>通用：http 是通用协议，没有额外的沟通成本；</li> <li>自带文档：充分利用 http 的语义写 REST 风格的 API，可不写文档。理由：它们已被很多人了解。</li> <li>好理解：由于上面的原因，接口好理解。</li> <li>方便调试：基于 1、2 的原因，联调很方便。</li> <li>对新人友好：新成员加入团队，没有规范文档，没有项目说明，基于前面三点，能让新人快速投入。</li></ol> <blockquote><p>需要额外定义错误状态吗？</p></blockquote> <p>遵循 REST 风格的 API，额外指定错误状态码，违背了充分利用 http 语义的原则，增加了沟通成本，是有害的。</p> <blockquote><p>不额外指定错误状态码，如何指定错误信息？</p></blockquote> <p>利用 http 状态码和返回消息表示错误，可<code>减少联调难度</code>，减少沟通。</p> <p>有些公司路径错误、参数格式不对，状态码都是 200，而且返回的错误信息不具体，随着接口参数字段的增加，调试难度成倍增加，文档还写得垃圾。<strong>最后进度延期，就让前端背锅。</strong></p> <p>http 状态码本身对 http 请求结果进行了分类，而且浏览器会显示错误的请求，外加自定义的信息，可大大降低调试成本。</p> <p>比如参数不符合预期，就设置状态码为<code>400</code>，在消息里面给出正确的参数提示和用户用户的信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">'输入不符合要求，请检查'</span><span class="token punctuation">,</span><span class="token comment">// 给用户看的</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span><span class="token string">'id 必须为数字；date 必需'</span> <span class="token comment">// 给开发看的</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p><strong>额外指定错误状态码，是非常不好的实践。</strong></p></blockquote> <blockquote><p>给出具体的错误信息会带来安全风险？</p></blockquote> <p>有人说，给出具体的接口错误信息，有安全风险。这属于后台代码问题，而不是接口设计问题。</p> <p>好的接口设计应该是易用的、能提高团队协作效率的。</p></div> <h3 id="如何在组件种中更方便的使用"><a href="#如何在组件种中更方便的使用" class="header-anchor">#</a> 如何在组件种中更方便的使用</h3> <p>在 main.js 挂载到 vue 的原型上。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$http <span class="token operator">=</span> http <span class="token comment">// 组件中 使用 this.$http 使用</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="如何优雅得封装-post"><a href="#如何优雅得封装-post" class="header-anchor">#</a> 如何优雅得封装 POST</h3> <p><code>优雅</code>是关键词。有些团队使用 GET 或者 POST 来执行一些危险操作，比如删除，再执行前，往往需要用户二次确认，通常的做法：<code>每个需要确认的接口，都写一遍二次确认的代码</code>，这是很不优雅的写法，会导致代码难以理解和维护。</p> <p>优雅的写法：在接口中传递参数，指定是否需要二次确认。</p> <p>以 Element UI 的确认框为例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> MessageBox <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'element-ui'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">post</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> confirm <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>confirm <span class="token operator">||</span> confirm<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      MessageBox<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span>confirm<span class="token punctuation">.</span>confirm <span class="token operator">||</span> <span class="token string">'确认操作吗'</span><span class="token punctuation">,</span> <span class="token string">'提示'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">confirmButtonText</span><span class="token operator">:</span> <span class="token string">'确定'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cancelButtonText</span><span class="token operator">:</span> <span class="token string">'取消'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// NOTE 不要使用 {} 包裹 params</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'取消请求'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>用户点击取消时，执行 <code>catch</code>，执行 reject ，会报错错误，但是这不是错误，所以不做处理。</p> <p>这些调用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">postHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'admin/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jack'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">confirm</span><span class="token operator">:</span> <span class="token string">'确定发送吗？'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$message</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gs5ayz0l8mj30t80bw75m.jpg" alt=""></p> <h3 id="如何处理错误"><a href="#如何处理错误" class="header-anchor">#</a> 如何处理错误</h3> <p>当接口出错时，往往需要提示用户，通常的做法是在每个接口调用的 catch 函数里写，比如上面的
<code>this.$message(error.msg)</code>。</p> <blockquote><p>可以统一处理吗？</p></blockquote> <p><strong>可以</strong>，在响应拦截器中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Message <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'element-ui'</span>

<span class="token keyword">const</span> <span class="token function-variable function">message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">Message</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> data<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">responseFailed</span> <span class="token operator">=</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> response <span class="token punctuation">}</span> <span class="token operator">=</span> error
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// handleError(response)</span>
    <span class="token function">message</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token function">logInfo</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token comment">// cons error = new Error(response.data.msg)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">redLog</span><span class="token punctuation">(</span><span class="token string">'没有网络'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'请检查网络连接'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>responseSuccess<span class="token punctuation">,</span> responseFailed<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>message 是错误提示框。</p> <p>logInfo(response) 是错误输出，<code>方便调试</code>，输出如下：</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gs5bewaxovj30t40bu40p.jpg" alt=""></p> <blockquote><p>还有哪些可能的需求？</p></blockquote> <ol><li><p>提交错误日志到服务器，方便监控状态和复现问题；</p></li> <li><p>针对不同的错误，进行不同的处理。</p></li></ol> <p>401 时，跳转到注册页面，用户注册后跳转回来；</p> <p>403 时，提示用户用登录，登录后再跳转回来；</p> <p>断网时，显示断网组件等。</p> <blockquote><p>需要再 rejected 错误吗？</p></blockquote> <p>如果已经给可能出现的错误，统一处理了，可以不再 reject ,而是<code>resolve()</code></p> <p>缺点：</p> <ol><li>接口不遵循 RESTful 理念，会增加额外的处理成本。</li></ol> <p>比如 404 也返回 200，在消息体里使用 code:404 表示没有资源，对 axios 而言，其实是成功的，还需要在响应成功拦截器里编写处理函数。</p> <ol start="2"><li>使用者会困惑</li></ol> <p>都 resolve 了，还报错？还没数据？</p> <p>优点：不用额外处理错误了，在 then 里拿数据即可。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">postHttp2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'admin/test'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ name: 'jack', age: 24 }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>可见，还是 reject 好。</p></blockquote> <blockquote><p>其实还可再提供一个 resolve 的接口，外部这样调用。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">getNoError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="如何取消请求"><a href="#如何取消请求" class="header-anchor">#</a> 如何取消请求</h3> <p>axios 可取消请求，我使用<code>new CancelToken</code>来取消。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>axiosGet<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>axiosGet 请求<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cancelAxiosGet<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>取消 axiosGet 请求<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
  <span class="token keyword">const</span> CancelToken <span class="token operator">=</span> axios<span class="token punctuation">.</span>CancelToken
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MyRouter'</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">cancel</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">axiosGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        axios
          <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'admin/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">cancelToken</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>cancel <span class="token operator">=</span> c
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>axios<span class="token punctuation">.</span><span class="token function">isCancel</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'取消请求'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cancel <span class="token operator">=</span> <span class="token keyword">null</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 取消请求</span>
      <span class="token function">cancelAxiosGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cancel <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">'取消请求'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="取消的原理"><a href="#取消的原理" class="header-anchor">#</a> 取消的原理</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cancel <span class="token operator">=</span> c
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>调用 <code>CancelToken</code>，得到一个取消配置，配置有 promise 实例。CancelToken 参数是一个函数，axios 调用该函数时，又传递一个函数，就是取消函数 c， c 又调用取消配置的 promise.resolve，在请求适配器内，检测到 promise 变化，在 then 中执行 xhr 的 reject 方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">CancelToken</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'executor must be a function.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> resolvePromise
  <span class="token comment">// NOTE 添加一个 promise 实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">promiseExecutor</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数</span>
    resolvePromise <span class="token operator">=</span> resolve
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Cancellation has already been requested</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    token<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cancel</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>可这样调用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> resole <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> cancel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token parameter">onResoled</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  resole <span class="token operator">=</span> onResoled
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 等同一执行</span>
cancel<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> myPromise <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">function</span> <span class="token function">myXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resole</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  myPromise <span class="token operator">=</span> promise
  <span class="token keyword">return</span> promise
<span class="token punctuation">}</span>

<span class="token comment">// 可以这样执行</span>
<span class="token function">myXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 也可以</span>
myPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>CancelToken 有一个 promise 属性，可以调用这样调用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token comment">// reject 是 xhr 的，而 message 是 cancel 函数传入的。</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>关键源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">xhrAdapter</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">dispatchXhrRequest</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onCanceled</span><span class="token punctuation">(</span><span class="token parameter">cancel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 取消请求</span>
        request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>cancel<span class="token punctuation">)</span>
        <span class="token comment">// Clean up request</span>
        request <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>组件的取消请求，需要用户手动点击按钮，要是能自动判断请求是否重复，取消重复请求才是期望的。</p> <h3 id="如何取消重复请求"><a href="#如何取消重复请求" class="header-anchor">#</a> 如何取消重复请求</h3> <p>既然取消的标准还是保存在请求配置里，就可以在拦截器里判断是否重复，然后取消重复。</p> <p>三种取消重复请求方案：</p> <ol><li>只允许最新的请求发送，老的请求都取消</li></ol> <p>实现关键：在<strong>请求拦截器</strong>里记录请求时，先判断是否已经存在，存在取消，再添加，保证记录都不同。</p> <p>优点：多次请求，保证了最新的请求发出，用户拿到的一定是最新的数据，类似<strong>防抖</strong>。</p> <p>缺点：</p> <p>①. 由于只有一个请求发出，可能失败，同时，网络慢的话，用户会等待更久。</p> <p>②. 同时可能后台已经处理请求到一半了，然后请求被取消了，马上又进来一个请求，可能会造成效率不会太高。</p> <blockquote><p>只允许最新的请求发出</p></blockquote> <p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h854izzaymj31hq0dwn1y.jpg" alt="允许最新的请求发出"></p> <hr> <ol start="2"><li>只允许最老的请求发送，新的请求都取消</li></ol> <p>实现关键：在<strong>请求拦截器</strong>里记录请求和取消请求，<strong>在响应拦截器</strong>重置记录，让用户可以再次发出。</p> <p>优点：多次请求，保证了最老的请求发出，服务器压力小。</p> <p>缺点：用户拿到的可能不是最新的数据。</p> <p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h86dhkhojmj31cu0lmqci.jpg" alt=""></p> <p>发出 14 个，后来的都取消了，第一个成功返回。</p> <hr> <ol start="3"><li>允许多个请求发送，有一个请求成功，取消其他还在处理的请求</li></ol> <p>实现关键：在<strong>请求拦截器</strong>记录每个请求，在<strong>响应成功拦截器</strong>中取消其他请求。</p> <p>优点：能保证请求至少返回一个，尤其是当单个失败的可能性比较大，允许发出多个，那么用户频繁操作，成功的概率就更大。</p> <p>缺点：</p> <p>①. 用户拿到的数据不能保证是最新的。</p> <p>②. 能否成功取消，由<strong>网络速度</strong>和这<strong>这部分代码</strong>执行速度决定，网络比代码快，比如网络 10 毫秒内返回，可能无法请求，原因是第一个网络成功了，第二个请求还没发出，即网络返回了，判断重复的函数还没执行。</p> <blockquote><p>重复的请求都发出</p></blockquote> <p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h85566dyiij31gy078jsq.jpg" alt="重复的请求都发出"></p> <blockquote><p>有一个请求成功后，其他正在进行的请求取消</p></blockquote> <p><img src="https://tva1.sinaimg.cn/large/008vxvgGly1h8557j50ycj31fe05i75p.jpg" alt="有一个请求成功，其他的请求取消"></p> <h3 id="取消重复请求的具体实现"><a href="#取消重复请求的具体实现" class="header-anchor">#</a> 取消重复请求的具体实现</h3> <p>当 url、method、参数一样，就是相同请求。</p> <p>第三种方案成功拿到数据的可能性大，它对用户更加友好，就讲它如何实现。</p> <p>在请求拦截器里记录请求：</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// NOTE 用于记录重复的请求</span>
<span class="token keyword">let</span> repeatRequests <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">generateRequestKey</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> config
  <span class="token keyword">const</span> split <span class="token operator">=</span> <span class="token string">'---'</span>
  <span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>split<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">method:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> method<span class="token punctuation">]</span>
  params <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>split<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">params:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
  data <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>split<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">data:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">:</span> data<span class="token punctuation">)</span>
  <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addPendingRequest</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> requestKey <span class="token operator">=</span> <span class="token function">generateRequestKey</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  config<span class="token punctuation">.</span>cancelToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">axios<span class="token punctuation">.</span>CancelToken</span><span class="token punctuation">(</span><span class="token parameter">cancel</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">!</span>repeatRequests<span class="token punctuation">[</span>requestKey<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>repeatRequests<span class="token punctuation">[</span>requestKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    repeatRequests<span class="token punctuation">[</span>requestKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cancel<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> config
<span class="token punctuation">}</span>
<span class="token comment">// 请求拦截器</span>
<span class="token keyword">const</span> <span class="token function-variable function">beforeRequest</span> <span class="token operator">=</span> <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE 记录请求</span>
  <span class="token function">addPendingRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token keyword">return</span> config
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>beforeRequest<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>在响应拦截器的成功方法中取消请求：</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">removePendingRequest</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> requestKey <span class="token operator">=</span> <span class="token function">generateRequestKey</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token keyword">const</span> needCancel <span class="token operator">=</span> repeatRequests<span class="token punctuation">[</span>requestKey<span class="token punctuation">]</span><span class="token operator">?.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needCancel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不重复，不取消</span>
    repeatRequests<span class="token punctuation">[</span>requestKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cancel</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">cancel</span><span class="token punctuation">(</span>requestKey<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  needCancel <span class="token operator">?</span> <span class="token punctuation">(</span>repeatRequests<span class="token punctuation">[</span>requestKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>repeatRequests <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 响应拦截器</span>
<span class="token keyword">const</span> <span class="token function-variable function">responseSuccess</span> <span class="token operator">=</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">removePendingRequest</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>高亮部分为关键代码。</p> <div class="custom-block tip"><p class="custom-block-title">如何判断重复请求</p> <p>对于 post、put 请求， data 的格式在请求时被 axios 根据<code>content-type</code>修改了，因为在请求拦截器和响应拦截器里都要获取请求标识，
都调用了 <code>generateRequestKey</code>, 需要把 data 处理成相同的格式。</p> <p>所以有：</p> <p><code>typeof data === 'object' ? JSON.stringify(data) : data</code></p></div> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>优雅地封装 axios 的关键：</p> <ol><li><p>提供快捷方法；</p></li> <li><p>统一处理错误；</p></li> <li><p>能二次确认；</p></li> <li><p>能取消重复请求；</p></li> <li><p>合理使用拦截器。</p></li></ol> <p>实现了关键功能，其他功能可根据需要添加。</p> <p>如果你有想说的，欢迎在 issue 里告诉我。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/blog/assets/js/app.f600d07b.js" defer></script><script src="/blog/assets/js/2.2efda491.js" defer></script><script src="/blog/assets/js/156.cd63d656.js" defer></script>
  </body>
</html>
